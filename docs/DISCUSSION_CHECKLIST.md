# 新 Tag 处理方案 - 讨论清单

## ✅ 已确认的需求

- [x] 新 tag 通过 Drone 构建完成后推送
- [x] 只能在特定条件下切换版本
- [x] PreDeploying 状态下用户能看到新 tag 但不能切换
- [x] 一个 batch 下的 app 可以使用不同版本
- [x] 任何有权限的用户都可以切换
- [x] 使用状态机管理，操作幂等
- [x] 不需要 TagUpdateHistory 表
- [x] 不需要通知和告警机制
- [x] 不需要版本对比功能

## ❓ 需要确认的细节

### 1. Webhook 和新 Tag 检测

- [ ] **Drone Webhook 格式**
  - 当前 `BuildNotifyRequest` 的格式是否满足需求？
  - 是否需要修改或扩展？
  - 示例：
    ```json
    {
      "build_number": 11,
      "build_status": "success",
      "apps": [
        {
          "name": "app-name",
          "image_tag": "v1.2.3"
        }
      ]
    }
    ```

- [ ] **新 Tag 检测的触发时机**
  - 是否只在构建成功时检测？
  - 还是所有构建都检测？
  - 当前代码中 `BuildNotifyRequest` 的 `apps` 字段是否包含所有应用？

- [ ] **多个应用的处理**
  - 一个 Webhook 中可能包含多个应用的构建信息
  - 是否需要逐个处理？
  - 是否需要事务处理？

### 2. 版本切换的条件

- [ ] **Batch 状态检查**
  - 当前代码中 Batch 的状态常量是什么？
  - PreWaiting 和 ProdWaiting 的具体值是多少？
  - PreDeploying 和 ProdDeploying 的具体值是多少？

- [ ] **Deployment 状态检查**
  - 如何判断 Deployment 是否正在运行？
  - 当前 Deployment 的状态有哪些？
  - 是否需要检查所有 Deployment 还是只检查最新的？

- [ ] **权限检查**
  - 是否需要检查用户是否有权限切换版本？
  - 当前是否有权限管理系统？
  - 是否需要添加权限检查？

### 3. 版本切换的实现

- [ ] **旧 Deployment 的处理**
  - 是否需要立即标记为 superseded？
  - 还是在新 Deployment 创建后再标记？
  - 是否需要保留旧 Deployment 的历史记录？

- [ ] **K8s 任务取消**
  - 如何获取 K8s 客户端？
  - 取消任务的 API 是什么？
  - 如果取消失败，是否中断整个流程？

- [ ] **新 Deployment 的创建**
  - 新 Deployment 是否需要立即部署？
  - 还是等待用户手动触发？
  - 是否需要复制旧 Deployment 的配置？

### 4. 数据库设计

- [ ] **新增字段**
  - 是否需要添加 `latest_build_id`？
  - 是否需要添加 `has_new_tag`？
  - 是否需要添加 `tag_updated_at` 和 `tag_updated_by`？
  - 是否需要添加其他字段？

- [ ] **Deployment 表扩展**
  - 是否需要添加 `is_superseded` 字段？
  - 是否需要添加 `superseded_at` 字段？
  - 是否需要添加 `superseded_by` 字段？

- [ ] **索引优化**
  - 是否需要为新字段添加索引？
  - 是否需要优化现有索引？

### 5. API 设计

- [ ] **Webhook 端点**
  - 当前是否已有 `/api/v1/builds/notify` 端点？
  - 是否需要修改现有端点？
  - 是否需要添加新的端点？

- [ ] **切换版本端点**
  - 端点路径是否为 `/api/v1/releases/{release_id}/switch-version`？
  - 请求体中是否需要包含其他信息？
  - 响应体中是否需要包含其他信息？

- [ ] **查询状态端点**
  - 端点路径是否为 `/api/v1/releases/{release_id}/status`？
  - 响应体中是否需要包含其他信息？

### 6. 状态机集成

- [ ] **新 Action**
  - 是否需要添加 `new_tag` action？
  - 是否需要添加 `switch_version` action？
  - 这些 action 是否需要改变 ReleaseApp 的状态？

- [ ] **状态转换**
  - 版本切换是否需要改变 ReleaseApp 的状态？
  - 还是只更新数据而不改变状态？

### 7. 错误处理

- [ ] **新 Tag 检测失败**
  - 如果查询 ReleaseApp 失败，是否返回错误？
  - 如果更新失败，是否需要重试？

- [ ] **版本切换失败**
  - 如果事务失败，是否自动回滚？
  - 是否需要记录失败原因？
  - 是否需要告警？

### 8. 日志和监控

- [ ] **日志记录**
  - 是否需要记录新 tag 检测的日志？
  - 是否需要记录版本切换的日志？
  - 日志级别应该是什么？

- [ ] **监控指标**
  - 是否需要记录新 tag 检测的次数？
  - 是否需要记录版本切换的次数？
  - 是否需要记录失败的次数？

### 9. 测试

- [ ] **单元测试**
  - 是否需要测试新 tag 检测逻辑？
  - 是否需要测试版本切换逻辑？
  - 是否需要测试错误处理？

- [ ] **集成测试**
  - 是否需要测试完整的流程？
  - 是否需要测试并发场景？

### 10. 文档

- [ ] **API 文档**
  - 是否需要更新 Swagger 文档？
  - 是否需要添加使用示例？

- [ ] **实现文档**
  - 是否需要记录实现细节？
  - 是否需要记录设计决策？

## 📋 讨论顺序建议

1. **Webhook 和新 Tag 检测** - 确认 Webhook 格式和检测逻辑
2. **版本切换的条件** - 确认状态检查的具体条件
3. **版本切换的实现** - 确认具体的实现步骤
4. **数据库设计** - 确认需要添加的字段
5. **API 设计** - 确认端点和请求/响应格式
6. **状态机集成** - 确认是否需要添加新的 action
7. **错误处理和日志** - 确认错误处理和日志记录的方式
8. **测试** - 确认测试的范围和方式

## 🎯 下一步

请根据上述清单逐个确认，我会根据你的反馈进行相应的调整和实现。

---

**版本：** v1.0  
**最后更新：** 2024-01-15  
**状态：** 待讨论

